# NASフォトギャラリー

Nuxt 3で構築された、NAS（ネットワーク接続ストレージ）上の画像を閲覧するためのシンプルなフォトギャラリーアプリケーションです。

マウントした画像ディレクトリをWebインターフェース経由で閲覧できます。オンデマンドのサムネイル生成、基本的な認証、クリーンでレスポンシブなUIを備えています。

## 主な機能

-   Webベースの画像ブラウジング
-   高速な読み込みを実現するオンデマンドのサムネイル生成
-   レスポンシブなグリッドレイアウト
-   フルサイズの画像を表示するためのライトボックス（モーダル表示）機能
-   ギャラリーを保護するための基本認証
-   画像データベースを効率的に更新するための差分スキャン
	-   サムネイルはアクセス時にオンデマンド生成（生成結果は `.cache/thumbs/` に保存し、原子的に配置）
	-   破損 (0バイト) サムネイルは再アクセス時に再生成されます

## セットアップとインストール

### 1. 前提条件

-   [Node.js](https://nodejs.org/) (v18以降を推奨)
-   アプリケーションを実行するマシンからアクセス可能な画像ディレクトリ（例: マウントされたNAS共有）

### 2. リポジトリのクローン

```bash
git clone <your-repository-url>
cd nas-gallery
```

### 3. 依存関係のインストール

```bash
npm install
```

### 4. 環境変数の設定

プロジェクトのルートに、サンプルファイルをコピーして`.env`ファイルを作成します。

```bash
cp .env.example .env
```

次に、`.env`ファイルをご自身の環境に合わせて編集します。

```
# 画像が保存されているルートディレクトリへの絶対パス（例: NASのマウントポイント）
IMAGE_ROOT=/path/to/your/nas/photos

# 基本認証の認証情報
BASIC_AUTH_USER=admin
BASIC_AUTH_PASS=your-secret-password

# (任意) アプリケーションのポート番号
NUXT_PORT=3000

# (任意) サムネイルの幅（ピクセル単位）
NUXT_PUBLIC_THUMBNAIL_WIDTH=400
```

**【重要】**
-   `IMAGE_ROOT`には、画像が格納されているディレクトリへの**絶対パス**を指定してください。
-   `BASIC_AUTH_PASS`は、推測されにくい強力なパスワードに変更してください。

### 5. 画像ディレクトリのスキャン

初めてアプリケーションを起動する前に、画像ディレクトリをスキャンしてデータベースを構築する必要があります。このコマンドは何度実行しても安全です（冪等性があります）。

```bash
npm run scan
```

このスクリプトは以下の処理を行います。
-   `IMAGE_ROOT`内のすべての画像ファイル（.jpg, .jpeg, .png, .gif）を検索します。
-   見つかったファイル情報をローカルのSQLiteデータベース（`data/meta.db`）に登録します。
-   以前登録されていたが見つからなくなったファイルを「削除済み」としてマークします。

**注記：** スキャンスクリプト自体はサムネイルを事前生成しません。サムネイルは初回アクセス時にオンデマンドで生成され、二重生成や同時アクセスによる破損を避けるため一時ファイル → リネームで原子的に保存されます。

画像を追加、削除、更新した際には、このスキャンコマンドを再度実行してください。

### 6. アプリケーションの起動

```bash
npm run dev
```

ブラウザで `http://localhost:3000` （または指定したポート）にアクセスします。`.env`ファイルで設定したユーザー名とパスワードの入力が求められます。

## 使い方

-   **閲覧:** ギャラリーをスクロールして画像を閲覧します。画像はページ単位で読み込まれます。
-   **フルサイズ表示:** サムネイルをクリックすると、フルサイズの画像がライトボックス（モーダル）で表示されます。ライトボックス内で画像の切り替えも可能です。
-   **ライブラリの更新:** `IMAGE_ROOT`ディレクトリに画像を追加・削除した場合は、一度アプリケーションを停止し、`npm run scan`を再実行してから、再度アプリケーションを起動してください。

## データベースのリセット

誤ったスキャン結果やクリーンアップを行いたい場合は、以下のコマンドでSQLiteデータベース (`data/meta.db`) をリセットできます。

```
npm run reset:db            # ソフトリセット: レコード削除 (スキーマ保持)
npm run reset:db -- --hard  # ハードリセット: DBファイル削除→再初期化
npm run reset:db -- --images-only # images / image_tags のみ削除
```

`--force` を付けると確認プロンプトをスキップします。リセット後は必要に応じて `npm run scan` を再度実行してください。

## サムネイルキャッシュについて

生成されたサムネイルは `.cache/thumbs/` に保存されます。存在しない場合のみ Sharp で生成し、0バイトなど破損キャッシュは検出時に自動削除して再生成します。HTTPレスポンスには以下のヘッダが付与されます:

- `X-Thumb-Gen: hit` 既存キャッシュを利用
- `X-Thumb-Gen: miss` 新規生成

ブラウザキャッシュ用に `Cache-Control: public, max-age=3600` を付与しています。必要に応じて `nuxt.config.ts` の `routeRules` でCDNキャッシュポリシーを調整してください。

